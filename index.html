<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mobile Poster Editor</title>

<style>
body {
  font-family: Arial, sans-serif;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 10px;
  padding: 20px;
  background: #f2f2f2;
}

.canvas-wrapper {
  position: relative;
  display: inline-block;
}

canvas {
  display: block;
  max-width: 100%;
  touch-action: none; /* disables default pinch/scroll gestures */
  background: #eee;
  cursor: grab;
}

.button-row {
  display: flex;
  gap: 6px;
  justify-content: center;
  margin-bottom: 10px;
}

.upload-btn, #cameraBtn, #downloadBtn {
  background: white;
  border: 1px solid #bbb;
  padding: 6px 8px;
  border-radius: 6px;
  font-size: 14px;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 4px;
}

.upload-btn:hover,
#cameraBtn:hover,
#downloadBtn:hover {
  background: #f0f0f0;
}

input[type="file"] {
  display: none;
}
</style>
</head>
<body>

<h2>Upload or Click a Picture</h2>

<div class="button-row">
  <label class="upload-btn" for="imgUploadInput">üìÅ Upload</label>
  <button id="cameraBtn">üì∏ Camera</button>
  <button id="downloadBtn">Download</button>
</div>

<div class="canvas-wrapper">
  <canvas id="finalCanvas"></canvas>
  <input type="file" id="imgUploadInput" accept="image/*">
  <input type="file" id="imgCameraInput" accept="image/*" capture="environment">
</div>

<script>
const canvas = document.getElementById("finalCanvas");
const ctx = canvas.getContext("2d");

const poster = new Image();
poster.src = "WhatsApp Image 2025-11-22 at 07.34.17_e0b8aebb.jpg";

const frame = {
  x: 371,
  y: 1340,
  r: Math.hypot(592 - 363, 1318 - 1330) * 0.9,
  img: null
};

let scaleFactor = 1;
let imgScale = 1;
let posX = 0, posY = 0;

let isDragging = false;
let startX = 0, startY = 0;

let pinchStartDist = 0;
let pinchStartScale = 1;
let pinchCenter = { x: 0, y: 0 };

// Load poster
poster.onload = () => {
  const w = poster.width;
  const h = poster.height;

  scaleFactor = Math.min(window.innerWidth * 0.95 / w, 1);
  canvas.width = w * scaleFactor;
  canvas.height = h * scaleFactor;

  frame.x *= scaleFactor;
  frame.y *= scaleFactor;
  frame.r *= scaleFactor;

  draw();
};

function draw() {
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.drawImage(poster,0,0,canvas.width,canvas.height);

  if(frame.img){
    ctx.save();
    ctx.beginPath();
    ctx.arc(frame.x, frame.y, frame.r, 0, Math.PI*2);
    ctx.clip();

    ctx.drawImage(
      frame.img,
      posX,
      posY,
      frame.img.width * imgScale * scaleFactor,
      frame.img.height * imgScale * scaleFactor
    );

    ctx.restore();
  }

  // Frame border
  ctx.beginPath();
  ctx.arc(frame.x, frame.y, frame.r, 0, Math.PI*2);
  ctx.lineWidth = 2;
  ctx.strokeStyle = "#fff";
  ctx.stroke();
}

// Image upload
function handleImageSelect(e){
  const file = e.target.files[0];
  if(!file) return;

  const img = new Image();
  img.onload = () => {
    frame.img = img;
    imgScale = 1;
    posX = frame.x - (img.width*scaleFactor)/2;
    posY = frame.y - (img.height*scaleFactor)/2;
    draw();
  };
  img.src = URL.createObjectURL(file);
}

document.getElementById("imgUploadInput").addEventListener("change", handleImageSelect);
document.getElementById("cameraBtn").addEventListener("click", ()=> {
  document.getElementById("imgCameraInput").click();
});
document.getElementById("imgCameraInput").addEventListener("change", handleImageSelect);

// Touch controls
canvas.addEventListener("touchstart", e=>{
  if(!frame.img) return;

  if(e.touches.length===2){
    const dx = e.touches[0].clientX - e.touches[1].clientX;
    const dy = e.touches[0].clientY - e.touches[1].clientY;
    pinchStartDist = Math.hypot(dx,dy);
    pinchStartScale = imgScale;

    const rect = canvas.getBoundingClientRect();
    pinchCenter.x = (e.touches[0].clientX + e.touches[1].clientX)/2 - rect.left;
    pinchCenter.y = (e.touches[0].clientY + e.touches[1].clientY)/2 - rect.top;
  } else if(e.touches.length===1){
    isDragging = true;
    startX = e.touches[0].clientX;
    startY = e.touches[0].clientY;
  }
});

canvas.addEventListener("touchmove", e=>{
  e.preventDefault();
  if(!frame.img) return;

  if(e.touches.length===2){
    const dx = e.touches[0].clientX - e.touches[1].clientX;
    const dy = e.touches[0].clientY - e.touches[1].clientY;
    const dist = Math.hypot(dx,dy);

    const targetScale = Math.max(0.3, Math.min(5, pinchStartScale * dist / pinchStartDist));

    // Smooth lerp
    imgScale += (targetScale - imgScale) * 0.25;

    const ratio = imgScale / (imgScale - (targetScale - imgScale)*0.25);
    posX = pinchCenter.x - (pinchCenter.x - posX) * ratio;
    posY = pinchCenter.y - (pinchCenter.y - posY) * ratio;

    draw();
  } else if(e.touches.length===1 && isDragging){
    posX += e.touches[0].clientX - startX;
    posY += e.touches[0].clientY - startY;
    startX = e.touches[0].clientX;
    startY = e.touches[0].clientY;
    draw();
  }
});

canvas.addEventListener("touchend", e=>{
  if(e.touches.length<2) pinchStartDist=0;
  if(e.touches.length===0) isDragging=false;
});

// Download
document.getElementById("downloadBtn").addEventListener("click", ()=>{
  const link = document.createElement("a");
  link.download = "poster_output.png";
  link.href = canvas.toDataURL();
  link.click();
});
</script>

</body>
</html>
